<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" dir="ltr">
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1">
    <title>Users Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
</head>
<body>


<!--  Навбар  -->


<nav class="navbar navbar-expand-md bg-dark navbar-dark">
    <a class="navbar-brand ms-4" id="navbar-head">
        <!--Filling via JSON-->
    </a>
    <div class="collapse navbar-collapse d-flex justify-content-end me-4">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" th:href="@{/logout}">
                    Logout
                </a>
            </li>
        </ul>
    </div>
</nav>
<div class="container-fluid">
    <div class="row">
        <div class="col-2">
            <br>
            <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                <button class="nav-link active" id="v-pills-home-tab" data-bs-toggle="pill"
                        data-bs-target="#v-pills-home"
                        type="button" role="tab" aria-controls="v-pills-home" aria-selected="true">Admin
                </button>
                <button class="nav-link" id="v-pills-profile-tab" data-bs-toggle="pill"
                        data-bs-target="#v-pills-profile"
                        type="button" role="tab" aria-controls="v-pills-profile" aria-selected="false">User
                </button>
            </div>
        </div>

        <div class="col-10">


            <!--Таблица юзеров -->


            <div class="tab-content" id="v-pills-tabContent">
                <div class="tab-pane fade show active" id="v-pills-home" role="tabpanel"
                     aria-labelledby="v-pills-home-tab"
                     tabindex="0">

                    <h1>Admin panel</h1>

                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="home-tab" data-bs-toggle="tab"
                                    data-bs-target="#home-tab-pane"
                                    type="button" role="tab" aria-controls="home-tab-pane" aria-selected="true">
                                All users
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="profile-tab" data-bs-toggle="tab"
                                    data-bs-target="#profile-tab-pane"
                                    type="button" role="tab" aria-controls="profile-tab-pane" aria-selected="false">
                                New user
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content" id="myTabContent" style="margin-right: 500px;">
                        <div class="tab-pane fade show active" id="home-tab-pane" role="tabpanel"
                             aria-labelledby="home-tab"
                             tabindex="0">
                            <nav class="navbar navbar-expand-md bg-light navbar-light">
                                <a class="navbar-brand ms-4">
                                    <h5>All users</h5>
                                </a>
                            </nav>
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered">
                                    <thead class="table-dark">
                                    <tr>
                                        <th> ID</th>
                                        <th> Username</th>
                                        <th> Age</th>
                                        <th> Role</th>
                                        <th> Edit</th>
                                        <th> Delete</th>
                                    </tr>
                                    </thead>

                                    <tbody id="full">
                                    <!--Filling via JSON-->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="profile-tab-pane" role="tabpanel"
                             aria-labelledby="profile-tab"
                             tabindex="0">
                            <nav class="navbar navbar-expand-md bg-light navbar-light">
                                <a class="navbar-brand ms-4">
                                    <h5>New user</h5>
                                </a>
                            </nav>


                            <!--  Новый пользователь -->


                            <div class="container">
                                <div class="row">
                                    <div class="col-lg-6 col-md-6 col-sm-6 container justify-content-center card">
                                        <div class="card-body">
                                            <form class="add-user-form" id="new-user-form">
                                                <div class="form-group">
                                                    <strong class="d-flex justify-content-center"> Username
                                                    </strong>
                                                    <input
                                                            type="text"
                                                            id="username"
                                                            class="form-control"
                                                            placeholder="Enter username"
                                                            required
                                                    />
                                                </div>
                                                <div class="form-group">
                                                    <strong class="d-flex justify-content-center"> Age </strong>
                                                    <input
                                                            type="number"
                                                            min="0"
                                                            id="age"
                                                            class="form-control"
                                                            placeholder="Enter age"
                                                    />
                                                </div>
                                                <div class="form-group">
                                                    <strong class="d-flex justify-content-center"> Password
                                                    </strong>
                                                    <input
                                                            type="text"
                                                            id="password"
                                                            class="form-control"
                                                            placeholder="Enter password"
                                                            required
                                                    />
                                                </div>
                                                <div class="form-group">
                                                    <strong class="d-flex justify-content-center"> Role
                                                    </strong>
                                                    <select size="2" id="singleRoleId"
                                                            class="form-control" required>
                                                        <!--Filling via JSON-->
                                                    </select>
                                                </div>

                                                <br>

                                                <div class="d-grid gap-2 col-4 mx-auto">
                                                    <button type="submit" class="btn btn-success">
                                                        Add new user
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User -->

                <div class="tab-pane fade" id="v-pills-profile" role="tabpanel" aria-labelledby="v-pills-profile-tab"
                     tabindex="0">

                    <h1>
                        User information-page
                    </h1>

                    <nav class="navbar navbar-expand-md bg-light navbar-light">
                        <!-- Brand -->
                        <a class="navbar-brand ms-4">
                            <h5>About user</h5>
                        </a>
                    </nav>

                    <div class="table-responsive" style="margin-right: 500px;">
                        <table class="table table-striped table-bordered">
                            <thead class="table-dark">
                            <tr>
                                <th> ID</th>
                                <th> Username</th>
                                <th> Age</th>
                                <th> Role</th>
                            </tr>
                            </thead>

                            <tbody id="table">
                            <!--Filling via JSON-->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!--SCRIPTS-->


<script>

    fillUsersTable();
    addingEditModal();
    getRoles();

    // Таблица
    function fillUsersTable() {
        fetch("admin/api/users").then(
            res => {
                res.json().then(
                    data => {
                        data.forEach((u) => {
                            let rolesHtml = ""; // Переменная для хранения HTML-кода ролей пользователя
                            u.roles.forEach((role) => {
                                rolesHtml += `<span>${role.name}</span><br>`; // Добавляем каждую роль в переменную rolesHtml
                            });
                            // Создайте строку таблицы
                            let rowHtml = `<tr id=tr_${u.id}>
                            <td>${u.id}</td>
                            <td>${u.username}</td>
                            <td>${u.age}</td>
                            <td>${rolesHtml}</td>
                             <td class="text-center" ">
                                <div class="btn-toolbar" id="btn-toolbar-${u.id}">
                                    <button type="button" class="btn btn-primary mx-auto"
                                        data-bs-toggle="modal" data-bs-target="#edit${u.id}"
                                        id="edit-button-${u.id}">Edit</button>
                                </div>
                            </td>
                           <td class="text-center">
                                <button type="button" class="btn btn-danger mx-auto"
                                    data-bs-toggle="modal" data-bs-target="#delete${u.id}"
                                    id="delete-button-${u.id}">Delete</button>
                            </td>
                        </tr>`;

                            // Вставьте строку в таблицу
                            document.getElementById("full").insertAdjacentHTML('beforeend', rowHtml);
                        });
                    })
            }
        )
    }

    // Юзер
    (function () {
        fetch("user/api").then(
            res => {
                res.json().then(
                    data => {
                        let rolesHtml = ""; // Переменная для хранения HTML-кода ролей пользователя
                        data.roles.forEach((role) => {
                            rolesHtml += `<span>${role.name}</span><br>`; // Добавляем каждую роль в переменную rolesHtml
                        });

                        document.getElementById('navbar-head').innerHTML = `
                    <strong>${data.username}</strong>
                    with roles:
                    ${rolesHtml}`;
                        document.getElementById("table").innerHTML = `
                    <tr>
                    <td>${data.id}</td>
                    <td>${data.username}</td>
                    <td>${data.age}</td>
                    <td>${rolesHtml}</td></tr>`;
                    }
                )
            }
        );
    })();

    // Редактирование
    function addingEditModal(id) {
        var firstTime = [];
        fetch("admin/api/users").then(
            res => {
                res.json().then(
                    data => {
                        data.forEach((u) => {
                            if (id !== undefined && u.id !== id) return;
                            document.getElementById('btn-toolbar-' + u.id).addEventListener('mouseover', (e) => {
                                e.preventDefault();
                                if (!firstTime[u.id]) {
                                    document.getElementById('btn-toolbar-' + u.id).insertAdjacentHTML('beforeend', `
                                <form id="edit-form-${u.id}">
                                    <div class="modal fade" id="edit${u.id}" tabindex="-1"
                                    aria-labelledby="exampleModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h1 class="modal-title fs-5" id="exampleModalLabel2">
                                                        Edit user</h1>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="form-group">
                                                        <strong class="d-flex justify-content-center">
                                                            ID
                                                        </strong>
                                                        <input
                                                            type="text"
                                                            disabled="disabled"
                                                            id="id"
                                                            value="${u.id}"
                                                            class="form-control"
                                                        />
                                                    </div>

                                                    <div class="form-group">
                                                        <strong class="d-flex justify-content-center">
                                                             Username
                                                        </strong>
                                                        <input
                                                            type="text"
                                                            id="username"
                                                            value="${u.username}"
                                                            class="form-control"
                                                        />
                                                    </div>

                                                    <div class="form-group">
                                                        <strong class="d-flex justify-content-center">
                                                            Age
                                                        </strong>
                                                        <input
                                                            type="number"
                                                            min="0"
                                                            id="age"
                                                            value="${u.age}"
                                                            class="form-control"
                                                        />
                                                    </div>

                                                    <div class="form-group">
                                                        <strong class="d-flex justify-content-center">
                                                            Password
                                                        </strong>
                                                        <input
                                                            type="text"
                                                            id="password"
                                                            value="${u.password}"
                                                            class="form-control"
                                                            required
                                                        />
                                                    </div>
                                                    <div class="form-group" id="edit-roles-${u.id}">
                                                        <strong class="d-flex justify-content-center">
                                                            Role
                                                        </strong>
                                                        <select size="2"
                                                            id="singleRoleId${u.id}"
                                                            class="form-control"
                                                            required>
                                                            <!--Filling via JSON-->
                                                        </select>
                                                    </div>
                                                </div>

                                                <div class="modal-footer">
                                                    <button type="button"
                                                        class="btn btn-secondary"
                                                        data-bs-dismiss="modal" id="close-button-edit-${u.id}">
                                                        Close
                                                    </button>
                                                    <button type="submit" class="btn btn-primary">
                                                        Edit
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            `);

                                    getRoles(u.id); // вызываем для созданной модалки заполнение ролей
                                    addingDeleteModal(u.id) // вызываем создание модалки удаления
                                    editUser(u.id); // вызываем функцию отправки данных на контроллер
                                    firstTime[u.id] = true; // Добавляем проверку, если модальные окна были сформированы,
                                    // мы их не задваиваем
                                }
                            });
                        })
                    })
            })
    }
    function getRoles(id) {
        if (id === undefined) {
            id = "";
        }
        const roles = [
            { id: 1, name: "ADMIN" },
            { id: 2, name: "USER" },
        ];
        const selectElement = document.getElementById("singleRoleId");
        // Обновляем идентификатор элемента на "singleRoleId"
        // или используйте другой идентификатор, который соответствует вашему HTML-коду
        roles.forEach((r) => {
            let el = document.createElement("option");
            el.value = r.id;
            el.text = r.name;
            selectElement.appendChild(el);
        });
        const selectedRoleId = selectElement.value;
        return selectedRoleId;
    }

    function editUser(id) {
        let form = document.forms['edit-form-' + id];
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            fetch("/admin/api/update", {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: form.id.value,
                    username: form.username.value,
                    age: form.age.value,
                    password: form.password.value,
                    roles: document.getElementById('singleRoleId' + id).value
                })
            })
                .then(res => res.json())
                .then(u => { // Удаляем старую строчку и вставляем новую
                    document.getElementById('close-button-edit-' + u.id).click(); // закрываем вручную модалку
                    document.getElementById("tr_" + u.id).innerHTML =
                        `<tr id=tr_${u.id}><td>${u.id}</td>
                            <td>${u.username}</td>
                            <td>${u.age}</td>
                            <td>${u.roles}</td>
                            <td${u.id}">
                            <div class="btn-toolbar" id="btn-toolbar-${u.id}">
                            <button type="button"
                            class="btn btn-primary float-md-end mx-2"
                            data-bs-toggle="modal" data-bs-target="#edit${u.id}" id="edit-button-${u.id}">
                            Edit</button>
                            <button type="button"
                            class="btn btn-danger float-md-end mx-2"
                            data-bs-toggle="modal" data-bs-target="#delete${u.id}" id="delete-button-${u.id}">
                            Delete</button>
                            </td></tr>`;
                    addingEditModal(u.id); // вызываем добавление обработчиков событий для вызова модалок на новой строчке
                });
        });
    }
    function addingDeleteModal(id) {
        fetch("admin/api/user/" + id).then(
            res => {
                res.json().then(
                    (u) => {
                        document.getElementById('btn-toolbar-' + u.id).insertAdjacentHTML('beforeend', `
                                <form id="delete-form-${u.id}">
                                    <div class="modal fade" id="delete${u.id}" tabindex="-1"
                                    aria-labelledby="exampleModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h1 class="modal-title fs-5" id="exampleModalLabel2">
                                                        Delete user</h1>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="form-group">
                                                        <strong class="d-flex justify-content-center">
                                                            ID
                                                        </strong>
                                                        <input
                                                            type="text"
                                                            disabled="disabled"
                                                            id="id"
                                                            value="${u.id}"
                                                            class="form-control"
                                                        />
                                                    </div>

                                                    <div class="form-group">
                                                        <strong class="d-flex justify-content-center">
                                                             Username
                                                        </strong>
                                                        <input
                                                            type="text"
                                                            id="username"
                                                            value="${u.username}"
                                                            class="form-control"
                                                            disabled="disabled"
                                                        />
                                                    </div>

                                                    <div class="form-group">
                                                        <strong class="d-flex justify-content-center">
                                                            Age
                                                        </strong>
                                                        <input
                                                            type="number"
                                                            min="0"
                                                            id="age"
                                                            value="${u.age}"
                                                            class="form-control"
                                                            disabled="disabled"
                                                        />
                                                    </div>


                                                    <div class="form-group" id="delete-roles-${u.id}">
                                                        <strong class="d-flex justify-content-center">
                                                            Role
                                                        </strong>
                                                        <select size="2"
                                                            id="deleteSingleRoleId${u.id}"
                                                            class="form-control"
                                                            disabled="disabled">
                                                            <!--Filling via JSON-->
                                                        </select>
                                                    </div>
                                                </div>

                                                <div class="modal-footer">
                                                    <button type="button"
                                                        class="btn btn-secondary"
                                                        data-bs-dismiss="modal" id="close-button-delete-${u.id}">
                                                        Close
                                                    </button>
                                                    <button type="submit" class="btn btn-danger">
                                                        Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            `);
                        document.getElementById('deleteSingleRoleId' + id).innerHTML = document.getElementById('singleRoleId' + id).innerHTML;
                        deleteUser(u.id); // вызываем функцию отправки данных на контроллер
                    })
            })
    }
    function deleteUser(id) {
        let form = document.forms['delete-form-' + id];
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            fetch("/admin/api/delete/" + id, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: form.id.value,
                    username: form.username.value,
                    age: form.age.value,
                    singleRoleId: document.getElementById('deleteSingleRoleId' + id).value
                })
            });
            document.getElementById('close-button-delete-' + id).click(); // закрываем вручную модалку
            document.getElementById("tr_" + id).remove();
        });
    }
    // Сохраняем нового юзера, добавляем в таблицу, очищаем форму и перемещаемся к новой строчке
    // Самовызываемая функция добавления обработчика события
    (function () {
        let form = document.forms['new-user-form'];
        form.addEventListener('submit', (e) => {
            e.preventDefault();

            const roles = [
                { id: 1, name: "ADMIN" },
                { id: 2, name: "USER" },
            ];

            const selectedRoleId = getRoles();

            fetch("/admin/api", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: form.username.value,
                    age: form.age.value,
                    password: form.password.value,
                    roles: [
                        {
                            id: selectedRoleId,
                            name: roles.find(r => r.id === selectedRoleId).name
                        }
                    ]
                })
            })
                .then(() => {
                    form.reset();
                })
                .then(res => res.json())
                .then(u => {
                    document.getElementById("full").insertAdjacentHTML('beforeend',
                        `<tr id=tr_${u.id}>
                        <td>${u.id}</td>
                        <td>${u.username}</td>
                        <td>${u.age}</td>
                        <td>${u.roles}</td>
                        <td>
                            <input type="hidden" id="singleRoleId${u.id}">
                            <div class="btn-toolbar" id="btn-toolbar-${u.id}">
                                <button type="button" class="btn btn-primary float-md-end mx-2" data-bs-toggle="modal" data-bs-target="#edit${u.id}" id="edit-button-${u.id}">
                                    Edit
                                </button>
                                <button type="button" class="btn btn-danger float-md-end mx-2" data-bs-toggle="modal" data-bs-target="#delete${u.id}" id="delete-button-${u.id}">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>`);
                    document.getElementById('home-tab').click();
                    document.getElementById('tr_' + u.id).scrollIntoView();
                    addingEditModal(u.id);
                });
        });
    })();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
        crossorigin="anonymous"></script>
</body>
</html>